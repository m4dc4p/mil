\usepackage[T1]{fontenc}
\usepackage{calc}
\usepackage{palatino}
\usepackage{amsfonts}
\renewcommand\ttdefault{lmtt}
\usepackage{helvet}
\usepackage{xspace}
\usepackage{url}
\usepackage{fancyvrb}
\usepackage[doublespacing]{setspace}
%% below only necessary when using doublespacing -- corrects
%% the vertical space inserted when switching to singlespace
%% environment.
\def\correctspaceskip{\vskip-\baselineskip} 
\usepackage{amsmath}
\usepackage{booktabs}
\usepackage[margin=\parindent, format=hang,labelfont=bf]{caption}
%% \usepackage[subrefformat=parens]{subcaption}
%% The following makes sure we get parentheses around
%% subreferences. The newest version of the subcaption
%% package has an option for this, but that's not available
%% widely.
%%
%% From http://tex.stackexchange.com/questions/25644
\usepackage[labelformat=simple]{subcaption}
\makeatletter
  \def\thesubfigure{(\alph{subfigure})}
  \providecommand\thefigsubsep{~}
  \def\p@subfigure{\@nameuse{thefigure}\thefigsubsep}
\makeatother

\usepackage{ifthen}
\usepackage{stmaryrd}
\usepackage{longtable}
\usepackage{afterpage}
\usepackage{xifthen}
\usepackage{mathtools}
\usepackage[natbib=true,style=authoryear,backend=bibtex8]{biblatex}
\setlength{\bibitemsep}{\bigskipamount}
\addbibresource{thesis.bib}
\usepackage{microtype}

%% GSO margins.
\usepackage[left=1.5in, right=1in, top=1in, bottom=1in]{geometry}
\usepackage{abstract}

%% GSO requires 12 pt font for all headings
\usepackage[bf,sf,tiny,compact]{titlesec}
\titleformat{\chapter}[display]
            {}% format
            {\sffamily\bfseries\chaptertitlename\ \thechapter}
            {\baselineskip}
            {\sffamily\bfseries}
            {}
\usepackage{lipsum}
\setlipsumdefault{1}

\hyphenation{data-flow mo-na-dic} 

\newboolean{lhs2tex}
\setboolean{lhs2tex}{true}

% Used by included files to know they
% are NOT standalone
\newboolean{standaloneFlag}
\setboolean{standaloneFlag}{true}

\newlength{\rulefigmargin}
\setlength{\rulefigmargin}{2\parindent}

\newcommand\figbegin{\rule{\linewidth}{0.4pt}\\\vspace{12pt}}
\newcommand\figend{\rule{\linewidth}{0.4pt}}

%% Sets
\newcommand{\setL}[1]{\textsc{#1}\xspace}
\newcommand{\setLC}{\setL{Const}}

%% Lub, subset operators.
\protected\def\lub{\ifmmode\sqcap\else\raisebox{.1em}{\ensuremath{\sqcap}}\fi\xspace}
\newcommand{\sqlt}{\ensuremath{\sqsubset}\xspace}
\newcommand{\sqlte}{\ensuremath{\sqsubseteq}\xspace}


%\providecommand{\citep}[1]{(\emph{#1})\xspace}
%\renewcommand{\cite}[1]{\emph{#1}\xspace}

%% Functional languages chapter commands
\newcommand{\lamA}{\ensuremath{\lambda}-calculus\xspace}
\newcommand{\LamA}{\ensuremath{\lambda}-Calculus\xspace}
\newcommand{\lamAbs}[2]{\ensuremath{\lambda#1.\ #2}}
\newcommand{\lamApp}[2]{\ensuremath{#1\ #2}}
\newcommand{\lamPApp}[2]{\ensuremath{(#1\ #2)}}
\newcommand{\lamAPp}[2]{\ensuremath{(#1)\ #2}}
\newcommand{\lamApP}[2]{\ensuremath{#1\ (#2)}}
\newcommand{\lamAPP}[2]{\ensuremath{(#1)\ (#2)}}
\let\lamApPp=\lamApP
\let\lamAppP=\lamAPp
%% LC definition
\newtoks\toksA
\protected\def\lcname#1/{\ensuremath{\mathit{#1}}}
\protected\def\lcdef#1(#2)=#3;{\def\arg{#2}%%
  \def\lcargs##1,##2/{\def\arg{##2}%%
    \ifx\empty\arg%%
    \lcname ##1/%%
    \else\lcname ##1/\ \lcargs ##2/%%
    \fi}%%
  \ifx\empty\arg\toksA={\ }%%
  \else\toksA={\ \lcargs #2,/\ }%%
  \fi%%
  \ensuremath{\lcname#1/\the\toksA =\ #3}}
%% Arbitary number of applied arguments, separated
%% by asterisks (*).
\protected\def\lcapp#1/{\def\lcappB##1*##2/{\def\arg{##2}%
    \ensuremath{\ifx\arg\empty%%
      \lcname ##1/%%
      \else%%
      \lcname##1/\ \lcappB##2/%%
      \fi}}%%
  %% Adding a star here makes
  %% sure our applicaitn always ends with an asterisks, ensuring
  %% #2 will be \empty at some point.
  \lcappB#1*/}
\protected\def\lcabs#1.{\ensuremath{\lambda#1.\ }}

\newcommand{\lamId}{\lamAbs{x}{x}}
\newcommand{\lamCompose}{\lamAbs{f}{\lamAbs{g}{\lamAbs{x}{\lamApp{f}{(\lamApp{g}{x})}}}}}
\newcommand{\machLam}{\ensuremath{M_\lambda}\xspace}
\newcommand{\compMach}[1]{\ensuremath{\left\llbracket #1 \right\rrbracket}}
\newcommand{\compRho}[1]{\ensuremath{\rho(#1)}}
\newcommand{\verSub}[2]{\ensuremath{#1_{#2}}}
\newcommand{\verSup}[2]{\ensuremath{#1^{#2}}}
\newcommand{\lamC}{\ensuremath{\lambda_C}\xspace}
\newcommand{\lamPlus}{\lamAbs{m}{\lamAbs{n}{\lamAbs{s}{\lamAbs{z}{\lamApp{m}{\lamApPp{s}{\lamApp{n}{\lamApp{s}{z}}}}}}}}}
%% Substitution notation -- [#1 -> #2]
\newcommand{\lamSubst}[2]{\ensuremath{[#1 \mapsto #2]}}
%% End functional languages chapter


%% MIL Chapter
\newcommand{\compMILE}[1]{\ensuremath{\left\llbracket #1 \right\rrbracket}}
\newcommand{\compMILV}[1]{\ensuremath{\left\llbracket #1 \right\rrbracket}}
\newcommand{\compMILQ}[2]{\ensuremath{\left\llbracket #2 \right\rrbracket}}
\newcommand{\milCtx}[1]{\ensuremath{\llfloor}#1\ensuremath{\rrfloor}}

%% This dimension makes sure the same amount of space
%% follows | and := in syntax rules like:
%%
%% term := var       (Variable)
%%      |  var var    (Application)
%%      |  \x. var    (Abstraction)
%%
\newdimen\termalign
\setbox0=\hbox{$:=$}
\termalign=\wd0 
\def\term#1/{\mathit{#1}}
\def\syntaxrule#1/{\hfil\text{\emph{#1}}}
\def\termrule#1:#2:#3/{\term #1/ &\hbox{$:=$}\ensuremath{\ #2} & \syntaxrule #3/}
\def\termcase#1:#2/{&\hbox to \termalign{$|$\hss}\ensuremath{\ #1} & \syntaxrule #2/}


%% End MIL chapter

%% Dataflow Chapter
% Domain function
\def\dom(#1){\ensuremath{\mfun{dom}(#1)}\xspace}
% Set of all integers.
\def\ZZ{\ensuremath{\mathbb{Z}}}
%%

%% Uncurrrying Chapter 
%% A space equal to a \thinspace, but we
%% break a line at it.
\newskip\thinskipamt \thinskipamt=.16667em 
\protected\def\thinskip{\hskip \thinskipamt\relax}
%% Capture a space token. Use a ``control-symbol'' (\. instead of \mksp)
%% to keep the trailing space from getting gobbled.
{\def\.{\global\let\sp= } \. }
%% Define \asp, which will capture the macro definition attached to space,
%% if one exists. Otherwise, \spa is relax after this.
{\catcode`\ =\active\gdef\asp{\ifx \relax\let\spa\relax\else\let\spa= \fi}}
\newtoks\foo
%% Removes spaces, implicit, active and explicit.
\protected\def\removespaces{\asp\afterassignment\removesp\let\next= }
\def\removesp{\foo={\next}\ifcat\noexpand\next\sp\foo={\removespace}%%
 \else\ifx\next\spa\foo={\removespaces}\fi%%
 \fi\the\foo}
\protected\long\def\lab#1/{\textbf{\ensurett{\removespaces #1}}}
%% Constructs a closure: l { v1, ..., vN }
\protected\long\def\mkclo[#1:#2]{\lab #1/\ensuremath{\thinspace\{\ensurett{#2}\}}\xspace}
%% Tuple version of closurs: {l: v1, ..., vN}.
\protected\long\def\clo[#1:#2]{\ensuremath{\{%%
      \ifx#1\relax%%
      \else\lab #1/%%
        \ifx#2\relax%%
        \else\ensurett{:\thinskip}%%
        \fi%%
      \fi\ensurett{#2}\}}\xspace}
%% Binding statement: v <- {...}
\protected\long\def\binds#1<-#2;{\ensurett{\removespaces #1\texttt{<-}#2}\xspace}
%% In order to use \binds in verbatim environment, have to define
%% delimiters while they are active. The below defines \vbinds which
%% must be used in AVerb environments.  Notice the active space as
%% well - that is necessary so the space after \vbinds (and before the
%% first argument) in the verbatim environment gets eaten.
\begingroup\catcode`\!=\active \lccode`\!=`\< \lccode`\~=`\- 
  \catcode`\ =\active\lowercase{\endgroup\def\vbinds#1!~#2;}{\binds#1<-#2;}
%% Return statement: return ... ;
\protected\long\def\return#1;{\ensurett{return\ \removespaces #1}}
%% A closure capturing block. k {v1, ..., vN} x: ...
\protected\long\def\ccblock#1(#2)#3:{\lab#1/\ensuremath{\thinspace\{\ensurett{#2}\}}\ \ensurett{#3:}}
%% A normal block
\protected\long\def\block#1(#2):{\lab #1/\ensuremath{\thinspace(\ensurett{#2})}\ensurett{:}}
%% A goto expression
\protected\long\def\goto#1(#2){\texttt{\textbf{\removespaces #1}}\ensuremath{\thinspace(\ensurett{#2})}}
%% An enter expression
\protected\long\def\app#1*#2/{\ensurett{\removespaces #1@#2}}
\protected\def\bind{\texttt{<-}\xspace}
%% Primitive expression
\protected\long\def\prim#1(#2){\lab #1/*\ensuremath{(\ensurett{#2})}}
%% Program variable
\protected\long\def\var#1/{\ensurett{\removespaces #1}\xspace}
\def\rhs{right--hand side\xspace}
\def\lhs{left--hand side\xspace}
\def\enter{\texttt{@}\xspace}
\def\cc{closure--capturing\xspace}
\def\Cc{Closure--capturing\xspace}
%%

\newenvironment{myfig}[1][tbh]{\begin{figure}[#1]%%
\begin{singlespace}\centering%%
\figbegin}{\figend\end{singlespace}%%
\end{figure}}

%% Produce a sub-caption and label it.
\newcommand{\scap}[2][1in]{\begin{minipage}{#1}%%
\subcaption{}\label{#2}\end{minipage}}

%% Produce a sub-caption with text.
\newcommand{\lscap}[3][\hsize]{\begin{minipage}{#1}%%
\subcaption{#3}\label{#2}\end{minipage}}

% single-argument comment. Do not put
% a space before the command when used
% or the file will have two spaces.
\newcommand{\rem}[1]{}

%% A verbatim environment with active charactesr
%% so we can use math shortcuts and macros
\DefineVerbatimEnvironment{AVerb}{Verbatim}{commandchars=\\\{\},%% 
  codes={\catcode`\_8\catcode`\$3\catcode`\^7},%%
  numberblanklines=false}

\DefineVerbatimEnvironment{Verb}{Verbatim}{commandchars=\\\[\],%% 
  numberblanklines=false}

%% Turn on line numbers for Haskell code, 
%% and reset the line number counter.
\newcommand{\hsNumOn}{\numberson\numbersreset}
\newcommand{\hsNumOff}{\numbersoff}
%% Turn on line numbering in Haskell code within
%% the environment, then turn it off. The optional
%% argument specifies a prefix that \hslabel can
%% use to generate line number references. If no prefix
%% is givne, \hslabel will have no effect.
\newtoks\prefixtoks
\def\mkhslabel#1{\prefixtoks={#1}\let\prefix=a}
\def\hslabel#1{\ifx\prefix\relax%%
  \else\label{\the\prefixtoks_#1}%%
  \fi}
\def\unhslabel{\let\prefix=\relax}
\newenvironment{withHsNum}{\numberson\numbersreset}{\numbersoff}
\newenvironment{withHsLabeled}[1]{\numberson\numbersreset\mkhslabel{#1}}{\unhslabel\numbersoff}

%% Paragraph run-in
\newcommand{\runin}[1]{\begingroup\noindent\sffamily\textbf{#1}\qquad\endgroup}

%% Chapter bibliographies
\newcommand{\standaloneBib}{%%
  \ifthenelse{\boolean{standaloneFlag}}%%
             {\begin{singlespace}
                 \printbibliography
             \end{singlespace}}{}}

%% Adds an equation number on demand.
\newcommand\addtag{\refstepcounter{equation}\tag{\theequation}}

%% For typesetting set definitions like {x | x \in f(y)}
\newcommand\setdef[2]{\ensuremath{\{#1\ |\ #2\}}}

%% For typesetting function names like dom(f) or out(b).
\newcommand\mfun[1]{\ensuremath{\mathit{#1}}}

%% Marginal notes
\newcommand\margin[2]{\marginpar{\begin{singlespace}\emph{\footnotesize #2}\end{singlespace}}\relax #1}

%% Describe intent of a passage
\newcommand\intent[1]{{\begin{singlespace}\noindent\leftskip=-1in\emph{\footnotesize Intent: #1}\end{singlespace}}\nopagebreak[1]}

%% In aligned/alignedat/gathered environments, you don't et
%% automatice equation numbers. This command makes sure to
%% label them properly.
\newcommand\labeleq[1]{\refstepcounter{equation}\label{#1}}

%% Creates a hanging paragraph, where the first line is not
%% indented but all other lines are.
\def\itempar#1{\noindent\hangindent=\parindent\hangafter=1 #1\quad}

%% Disable overfull messages with ridiculous hfuzz value
\def\disableoverfull{\hfuzz=10in}

%% Set parfillskip so stretching does NOT occur at the end of
%% a paragraph (i.e., list of elements). Disable indent at beginning
%% of paragraph. Also turn off underfull hbox warnings.
%%
%% Intended to be used in a \vbox that forms part of a table or graphic,
%% which we want to be line-broken but not exactly like a normal paragraph.
\long\def\disableparspacing#1;{\hbadness=100000\parindent=0pt\parfillskip=0pt\leftskip=0pt\rightskip=0pt%%
  \ifx#1\relax\else\hsize=#1\relax\fi}
\include{md}
\domd

%% Place an input file on the next page
\def\onnextpage#1{\afterpage{\clearpage\input{#1}\clearpage}}
